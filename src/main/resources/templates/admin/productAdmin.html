<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{/admin/layoutAdmin :: dynamic(~{::body})}">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
	<title>Document</title>
</head>

<body ng-app="app" ng-controller="ctrl">
	<div class="body-wrapper">
		<header class="app-header">
			<nav class="navbar navbar-expand-lg navbar-light">
				<ul class="navbar-nav">
					<li class="nav-item d-block d-xl-none"><a class="nav-link sidebartoggler nav-icon-hover"
							id="headerCollapse" href="javascript:void(0)"> <i class="ti ti-menu-2"></i>
						</a></li>
				</ul>
				<div class="navbar-collapse justify-content-end px-0" id="navbarNav">
					<ul class="navbar-nav flex-row ms-auto align-items-center justify-content-end">
						<li class="nav-item dropdown"><a class="nav-link nav-icon-hover" href="javascript:void(0)"
								id="drop2" data-bs-toggle="dropdown" aria-expanded="false"> <img
									src="/assets/images/profile/user-1.jpg" alt="" width="35" height="35"
									class="rounded-circle">
							</a>
							<div class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up"
								aria-labelledby="drop2">
								<div class="message-body"></div>
							</div>
						</li>
					</ul>
				</div>
			</nav>
		</header>

		<div class="container-fluid">
			<div class="card">
				<div class="card-body">
					<h5 class="card-title fw-semibold mb-4">Sản phẩm</h5>
					<div class="card">
						<div class="card-body">
							<form ng-submit="saveForm()">
								<div class="mb-3">
									<label class="form-label">Tên Sản Phẩm</label><span style="color: red;">*</span>
									<input type="text" class="form-control" ng-model="form.productName">
								</div>
								<div class="mb-3">
									<label class="form-label">Thương Hiệu</label><span style="color: red;">*</span>
									<select class="form-control" ng-model="form.thuongHieu"
										ng-options="thuongHieu as thuongHieu.tenThuongHieu for thuongHieu in thuongHieus track by thuongHieu.thuongHieuId">
										<option value="">Chọn thương hiệu</option>
									</select>
								</div>
								<div class="mb-3">
									<label class="form-label">Thể Loại</label><span style="color: red;">*</span> <select
										class="form-control" ng-model="form.category"
										ng-options="category as category.name for category in categories track by category.cateId">
										<option value="">Chọn thể loại</option>
									</select>
								</div>
								<div class="mb-3">
									<label class="form-label">Mô tả</label>
									<textarea class="form-control" ng-model="form.description"></textarea>
								</div>
								<div class="mb-3">
									<label class="form-label">Ảnh Sản Phẩm</label> <span style="color: red;">*</span>
									<input type="file" class="form-control" id="imgProduct"
										ng-model="form.imgProductFile"
										onchange="angular.element(this).scope().updateFileName(this.files)">
									<img style="max-width: 250px;" alt=""
										ng-src="{{ '/img/product/' + form.imgProduct }}">
								</div>

								<button type="submit" ng-if="!form.productId" class="btn btn-primary">Create</button>
								<button type="button" class="btn btn-warning" ng-click="updateForm()"
									ng-if="form.productId">Update</button>
								<button type="button" class="btn btn-danger" ng-click="deleteForm()"
									ng-if="form.productId">Delete</button>
								<button type="button" class="btn btn-success" ng-click="resetForm()">Reset</button>
							</form>
						</div>
					</div>
				</div>
				<table class="table">
					<thead>
						<tr>
							<th scope="col">STT</th>
							<th scope="col">Tên Sản Phẩm</th>
							<th scope="col">Thương Hiệu</th>
							<th scope="col">Thể Loại</th>
							<th scope="col">Ngày Nhập</th>
							<th scope="col"></th>
							<th scope="col"></th>
						</tr>
					</thead>
					<tbody>
						<tr ng-repeat="item in items">
							<th scope="row">{{ $index + 1 }}</th>
							<td>{{ item.productName }}</td>
							<td>{{ item.thuongHieu }}</td>
							<td>{{ item.category }}</td>
							<td>{{ item.ngayNhap | date: 'dd/MM/yyyy' }}</td>
							<td><button type="button" class="btn btn-danger" ng-click="edit(item)">Edit</button></td>
							<td><button type="button" class="btn btn-primary" ng-click="viewDetails(item)">...</button>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>

	<script>
		var app = angular.module('app', []);
		app.controller('ctrl', function ($scope, $http) {
			$scope.items = [];
			$scope.form = {};
			$scope.thuongHieus = [];
			$scope.categories = [];

			$scope.initialize = function () {
				$http.get("/rest/products").then(function (response) {
					// console.log(response.data);  // Kiểm tra dữ liệu trả về từ API
					$scope.items = response.data;
					$scope.items.forEach(item => {
						item.ngayNhap = new Date(item.ngayNhap);
					});
				});

				$http.get("/rest/products/thuongHieus").then(function (response) {
					// console.log(response.data);  // Kiểm tra dữ liệu trả về từ API
					$scope.thuongHieus = response.data;
				});

				$http.get("/rest/products/categories").then(function (response) {
					/* console.log(response.data); */  // Kiểm tra dữ liệu trả về từ API
					$scope.categories = response.data;
				});
			};

			$scope.initialize();

			$scope.edit = function (item) {
				$scope.form = angular.copy(item);

				// Cập nhật category và thuongHieu
				$scope.form.category = $scope.categories.find(category => category.name === item.category);
				$scope.form.thuongHieu = $scope.thuongHieus.find(thuongHieu => thuongHieu.tenThuongHieu === item.thuongHieu);
			};

			$scope.saveForm = function () {
				var items = angular.copy($scope.form);

				$http.post("/rest/products", items, {
					headers: {
						'Content-Type': 'application/json'
					}
				}).then(function (response) {
					// Xử lý phản hồi thành công
					response.data.ngayNhap = new Date(response.data.ngayNhap);
					$scope.items.push(response.data);
					$scope.resetForm();
					alert("Thêm sản phẩm thành công");
					// Không cần tải lại trang
				}).catch(function (error) {
					if (error.status == 400) {
						// Nếu trạng thái lỗi là 400 Bad Request, thông báo sản phẩm đã tồn tại
						alert("Sản phẩm đã tồn tại");
					} else {
						// Xử lý các lỗi khác
						alert("Thêm sản phẩm thất bại");
					}
					console.log("error", error);
				});
			};

			$scope.updateForm = function () {
				var confirmDelete = confirm("Bạn có muốn thay đổi thông tin không?");
				if (confirmDelete) {
					var items = angular.copy($scope.form);
					if (!items.productId) {
						alert("Không có ID sản phẩm để cập nhật");
						return;
					}
					$http.put("/rest/products/update/" + items.productId, items).then(function (response) {
						var index = $scope.items.findIndex(p => p.productId === items.productId);
						if (index !== -1) {
							$scope.items[index] = response.data; // Cập nhật item trong danh sách
							alert("Chỉnh sửa thành công");
							window.location.reload();
						} else {
							alert("Không tìm thấy sản phẩm để cập nhật");
						}
					}).catch(error => {
						alert("Chỉnh sửa thất bại");
						console.log("error", error);
					});
				}
			};

			$scope.deleteForm = function () {
				// Hiển thị hộp thoại xác nhận
				var confirmDelete = confirm("Bạn có chắc chắn muốn xóa sản phẩm này không?");
				if (confirmDelete) {
					var item = angular.copy($scope.form);
					$http.delete("/rest/products/delete/" + item.productId).then(function (response) {
						// Tìm và xóa sản phẩm khỏi danh sách
						var index = $scope.items.findIndex(p => p.productId === item.productId);
						if (index !== -1) {
							$scope.items.splice(index, 1);
							$scope.resetForm();
							alert("Xóa thành công");
						} else {
							alert("Không tìm thấy sản phẩm để xóa");
						}
					}).catch(function (error) {
						alert("Xóa thất bại");
						console.log("error", error);
					});
				} else {
					// Nếu người dùng chọn "No", không thực hiện hành động nào
					alert("Hành động xóa đã bị hủy");
				}
			};

			$scope.resetForm = function () {
				$scope.form = {};
			};

			$scope.updateFileName = function (files) {
				var data = new FormData();
				data.append('file', files[0]);
				// console.log('File data:', data.get('file')); // Check file data

				$http.post('/rest/upload', data, {
					transformRequest: angular.identity,
					headers: { 'Content-Type': undefined }
				}).then(function (response) {
					// console.log('Response data:', response.data); // Check server response
					if (response.data && response.data.name) {
						$scope.form.imgProduct = response.data.name;
						// Using $scope.$applyAsync to avoid $rootScope:inprog error
						$scope.$applyAsync();
					} else {
						console.error('Response does not contain file name');
					}
				}).catch(function (error) {
					alert("Lỗi upload hình");
					console.error('Upload error:', error.message); // Check error
				});
			};
		});
	</script>
</body>

</html>